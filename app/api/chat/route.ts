import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'

// پاسخ‌های از پیش تعریف شده برای سوالات رایج
const responses: Record<string, string> = {
  // سوالات خوش‌آمدگویی
  'سلام': 'سلام! خوش آمدید. چطور می‌تونم کمکتون کنم؟',
  'hello': 'سلام! خوش آمدید. چطور می‌تونم کمکتون کنم؟',
  'hi': 'سلام! خوش آمدید. چطور می‌تونم کمکتون کنم؟',
  
  // سوالات درباره پلتفرم
  'یوتیم کیت چیست': 'یوتیم کیت یک پلتفرم حرفه‌ای برای ساخت لینک‌های کوتاه و ردیابی UTM است. با این پلتفرم می‌تونید لینک‌های کوتاه بسازید، آمار کلیک‌ها رو ببینید و کمپین‌های بازاریابی خودتون رو ردیابی کنید.',
  'پلتفرم چیست': 'یوتیم کیت یک پلتفرم حرفه‌ای برای ساخت لینک‌های کوتاه و ردیابی UTM است. با این پلتفرم می‌تونید لینک‌های کوتاه بسازید، آمار کلیک‌ها رو ببینید و کمپین‌های بازاریابی خودتون رو ردیابی کنید.',
  'چیست': 'یوتیم کیت یک پلتفرم حرفه‌ای برای ساخت لینک‌های کوتاه و ردیابی UTM است.',
  
  // سوالات درباره لینک کوتاه
  'چطور لینک کوتاه بسازم': 'برای ساخت لینک کوتاه:\n1. وارد داشبورد شوید\n2. روی "ساخت لینک جدید" کلیک کنید\n3. لینک اصلی خود را وارد کنید\n4. در صورت نیاز، کد کوتاه دلخواه و پارامترهای UTM را اضافه کنید\n5. روی "ایجاد" کلیک کنید',
  'لینک کوتاه': 'برای ساخت لینک کوتاه، وارد بخش "ساخت لینک جدید" در داشبورد شوید و لینک اصلی خود را وارد کنید.',
  'ساخت لینک': 'برای ساخت لینک کوتاه، وارد بخش "ساخت لینک جدید" در داشبورد شوید.',
  
  // سوالات درباره UTM
  'utm چیست': 'UTM (Urchin Tracking Module) پارامترهایی هستند که به URL اضافه می‌شوند تا منبع ترافیک را ردیابی کنند. پارامترهای اصلی UTM شامل:\n- utm_source: منبع ترافیک (مثل google, facebook)\n- utm_medium: رسانه (مثل email, cpc)\n- utm_campaign: نام کمپین\n- utm_term: کلمه کلیدی\n- utm_content: محتوای خاص',
  'پارامتر utm': 'پارامترهای UTM برای ردیابی منبع ترافیک استفاده می‌شوند. می‌تونید این پارامترها رو هنگام ساخت لینک کوتاه اضافه کنید.',
  'ردیابی': 'با استفاده از پارامترهای UTM می‌تونید منبع ترافیک و عملکرد کمپین‌های بازاریابی خودتون رو ردیابی کنید.',
  
  // سوالات درباره آمار
  'آمار': 'در داشبورد می‌تونید آمار کامل کلیک‌ها، لینک‌های پربازدید و نمودارهای تحلیلی رو مشاهده کنید.',
  'نمودار': 'در داشبورد بخش "نمودار کلیک‌ها" وجود داره که روند کلیک‌ها رو در 30 روز گذشته نشون می‌ده.',
  'کلیک': 'آمار کلیک‌ها در داشبورد و همچنین در صفحه جزئیات هر لینک قابل مشاهده است.',
  
  // سوالات درباره QR Code
  'qr code': 'برای هر لینک کوتاه، QR Code به صورت خودکار تولید می‌شه. می‌تونید QR Code رو در صفحه جزئیات لینک مشاهده و دانلود کنید.',
  'کیو آر کد': 'برای هر لینک کوتاه، QR Code به صورت خودکار تولید می‌شه.',
  
  // سوالات درباره پلن‌ها
  'پلن': 'پلن‌های موجود:\n- رایگان: برای شروع و تست\n- پایه: 75,000 تومان ماهانه - برای کسب‌وکارهای کوچک\n- حرفه‌ای: 249,000 تومان ماهانه - برای کسب‌وکارهای بزرگ\nبرای مشاهده جزئیات بیشتر به صفحه "قیمت‌ها" مراجعه کنید.',
  'قیمت': 'پلن رایگان برای شروع، پلن پایه 75,000 تومان و پلن حرفه‌ای 249,000 تومان ماهانه است. برای جزئیات بیشتر به صفحه "قیمت‌ها" مراجعه کنید.',
  'ارتقا': 'برای ارتقا پلن، می‌تونید از منوی داشبورد یا صفحه تنظیمات اقدام کنید.',
  
  // سوالات درباره API
  'api': 'یوتیم کیت یک API کامل برای یکپارچه‌سازی ارائه می‌ده. برای مشاهده مستندات API به صفحه "API Docs" مراجعه کنید.',
  'مستندات': 'مستندات کامل API در صفحه "API Docs" موجود است.',
  
  // سوالات درباره پشتیبانی
  'پشتیبانی': 'برای دریافت پشتیبانی می‌تونید از بخش "تیکت‌های پشتیبانی" در داشبورد استفاده کنید. پلن‌های مختلف سطح پشتیبانی متفاوتی دارند.',
  'مشکل': 'اگر مشکلی دارید، می‌تونید از بخش "تیکت‌های پشتیبانی" در داشبورد تیکت ایجاد کنید.',
  'کمک': 'برای کمک می‌تونید:\n1. از بخش "راهنما" استفاده کنید\n2. تیکت پشتیبانی ایجاد کنید\n3. از مستندات API استفاده کنید',
  
  // سوالات عمومی
  'ویژگی': 'ویژگی‌های اصلی یوتیم کیت:\n- ساخت لینک‌های کوتاه\n- ردیابی UTM\n- داشبورد آمار کامل\n- QR Code\n- دسته‌بندی لینک‌ها\n- Import/Export\n- رمزگذاری لینک‌ها\n- تاریخ انقضا',
  'امکانات': 'امکانات یوتیم کیت شامل ساخت لینک کوتاه، ردیابی UTM، آمار کامل، QR Code، دسته‌بندی و API کامل است.',
}

// تابع برای پیدا کردن پاسخ مناسب
function findResponse(message: string): string {
  const lowerMessage = message.toLowerCase().trim()
  
  // جستجوی دقیق
  if (responses[lowerMessage]) {
    return responses[lowerMessage]
  }
  
  // جستجوی کلمات کلیدی
  for (const [key, response] of Object.entries(responses)) {
    if (lowerMessage.includes(key)) {
      return response
    }
  }
  
  // پاسخ پیش‌فرض
  return 'متأسفانه متوجه سوال شما نشدم. لطفاً سوال خود را به صورت واضح‌تر مطرح کنید. می‌تونید درباره:\n- ساخت لینک کوتاه\n- ردیابی UTM\n- آمار و نمودارها\n- QR Code\n- پلن‌ها و قیمت‌ها\n- API و مستندات\n- پشتیبانی\nسوال بپرسید.'
}

export async function POST(request: Request) {
  try {
    const session = await getServerSession(authOptions)
    
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: 'لطفاً وارد حساب کاربری خود شوید' },
        { status: 401 }
      )
    }

    const body = await request.json()
    const { message } = body

    if (!message || typeof message !== 'string') {
      return NextResponse.json(
        { error: 'پیام معتبر نیست' },
        { status: 400 }
      )
    }

    // پیدا کردن پاسخ مناسب
    const assistantMessage = findResponse(message)

    return NextResponse.json({
      success: true,
      message: assistantMessage,
    })
  } catch (error: any) {
    console.error('Chat API error:', error)
    
    return NextResponse.json(
      { error: 'خطایی در پردازش پیام رخ داد. لطفاً دوباره تلاش کنید.' },
      { status: 500 }
    )
  }
}


